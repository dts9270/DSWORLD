<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Notes</title>
<style>
  :root{
    --primary:#25D366;
    --bg:#ECE5DD;
    --bubble-me:#DCF8C6;
    --bubble-peer:#FFFFFF;
    --muted:#727272;
    --card:#FFFFFF;
  }
  [data-theme="dark"]{
    --bg:#0b1412;
    --card:#111a18;
    --bubble-me:#213522;
    --bubble-peer:#122024;
    --muted:#9aa0a0;
  }
  html,body{height:100%;margin:0;font-family:Helvetica, Arial, sans-serif;background:var(--bg);-webkit-font-smoothing:antialiased;touch-action:none}
  .app{height:100vh;display:flex;flex-direction:column;max-width:920px;margin:0 auto}
  .topbar{height:56px;background:var(--primary);color:#fff;display:flex;align-items:center;padding:8px 12px;gap:12px;user-select:none}
  .avatar{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.18);display:flex;align-items:center;justify-content:center;font-weight:700}
  .title{font-size:16px;font-weight:700}
  .subtitle{font-size:12px;color:rgba(255,255,255,0.9)}
  #codeModal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:transparent;z-index:999}
  .codeBox{width:92%;max-width:420px;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.12);display:flex;flex-direction:column;gap:12px}
  .pinInput{flex:1;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:16px}
  .pinBtn{background:var(--primary);color:#fff;border:none;padding:12px;border-radius:10px;font-weight:700}
  .chatArea{flex:1;display:flex;flex-direction:column;background:var(--bg)}
  .messages{flex:1;padding:14px;overflow:auto;display:flex;flex-direction:column;gap:8px;align-items:flex-start}
  .row.me{align-self:flex-end}
  .bubble{max-width:78%;padding:10px 12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.04);line-height:1.3}
  .bubble.me{background:var(--bubble-me)}
  .bubble.peer{background:var(--bubble-peer)}
  .meta{font-size:11px;color:var(--muted);margin-top:6px;text-align:right}
  .composer{display:flex;gap:8px;padding:10px;background:transparent;align-items:center}
  .attachBtn{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:transparent;border:none;font-size:20px}
  .msgInput{flex:1;padding:12px;border-radius:24px;border:1px solid #ddd;background:var(--card)}
  .sendBtn{background:var(--primary);color:#fff;border:none;padding:10px 16px;border-radius:20px;font-weight:700}
  .fileThumb{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,0.03);padding:8px;border-radius:8px}
  .thumbImg{width:72px;height:54px;object-fit:cover;border-radius:6px}
  #unlockOverlay,#blockOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99999}
  #blockOverlay{background:rgba(0,0,0,0.95);color:#fff;font-size:18px}
  #unlockOverlay .box{background:var(--card);padding:18px;border-radius:12px;min-width:260px}
  .smallNote{font-size:12px;color:var(--muted);margin-top:8px}
  /* gesture hint area (invisible) */
  #gestureZone{position:fixed;left:0;top:0;width:100px;height:80px;opacity:0;z-index:2}
  @media(max-width:700px){ .codeBox{margin:20px} .title{font-size:15px} }
</style>
</head>
<body>

<div class="app" id="app">
  <div class="topbar" id="topbar" title="">
    <div class="avatar" id="avatar">N</div>
    <div>
      <div class="title" id="contactTitle">Notes</div>
      <div class="subtitle" id="contactSub">Personal</div>
    </div>
    <div style="flex:1"></div>
    <div style="width:40px;height:40px;"></div>
  </div>

  <div class="chatArea">
    <div class="messages" id="messages"></div>

    <div id="filePreview" style="padding:10px"></div>

    <div class="composer">
      <button class="attachBtn" id="attachBtn">ðŸ“Ž</button>
      <input type="file" id="fileInput" style="display:none" />
      <input id="messageInput" class="msgInput" placeholder="Write note..." />
      <button class="sendBtn" id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- invisible gesture zone in top-left for hidden gesture -->
<div id="gestureZone" aria-hidden="true"></div>

<!-- Code entry modal (disguised PIN) -->
<div id="codeModal">
  <div class="codeBox" role="dialog" aria-modal="true">
    <input id="codeField" class="pinInput" placeholder="Access Note Key" autocomplete="off" />
    <div style="display:flex;gap:8px">
      <button class="pinBtn" id="codeEnter">Unlock</button>
      <button class="pinBtn" id="codeCancel" style="background:#e0e0e0;color:#000">Close</button>
    </div>
    <div class="smallNote">Enter your private note access code.</div>
  </div>
</div>

<!-- Unlock overlay (after lock) -->
<div id="unlockOverlay">
  <div class="box">
    <div style="font-weight:700;margin-bottom:8px">Unlock</div>
    <input id="unlockField" class="pinInput" placeholder="Enter PIN" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="pinBtn" id="unlockBtn">Unlock</button>
    </div>
  </div>
</div>

<!-- block overlay -->
<div id="blockOverlay"><div>Protected</div></div>

<script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>

<script>
/* ---------------- CONFIG ---------------- */
const SIGNAL_URL = "wss://free-signalling-chat.vercel.app/onlyus";

/* ---------- THEME AUTOTOGGLE (triple-tap top-left) ---------- */
(function(){
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(prefersDark) document.documentElement.setAttribute('data-theme','dark');
  let taps=0;
  document.getElementById('topbar').addEventListener('click', (e)=>{
    if(e.clientX < 120 && e.clientY < 80){
      taps++;
      setTimeout(()=>taps=0,700);
      if(taps>=3){
        if(document.documentElement.hasAttribute('data-theme')) document.documentElement.removeAttribute('data-theme');
        else document.documentElement.setAttribute('data-theme','dark');
        taps=0;
      }
    }
  });
})();

/* ----------------- STATE ----------------- */
let ws = null, pc = null, dc = null;
let myKey = null, theirKey = null;
let aesKey = null; // CryptoKey
let aesRawBytes = null;
let lastPin = null;
let peerJoined = false;
let fakeMode = false;

const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const codeModal = document.getElementById('codeModal');
const codeField = document.getElementById('codeField');
const codeEnter = document.getElementById('codeEnter');
const codeCancel = document.getElementById('codeCancel');
const unlockOverlay = document.getElementById('unlockOverlay');
const unlockField = document.getElementById('unlockField');
const unlockBtn = document.getElementById('unlockBtn');
const blockOverlay = document.getElementById('blockOverlay');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const attachBtn = document.getElementById('attachBtn');
const gestureZone = document.getElementById('gestureZone');

/* ---------- UI helpers ---------- */
function addMessageHTML(html, who='peer', time=null){
  const r = document.createElement('div'); r.className = 'row '+(who==='me'?'me':'');
  const b = document.createElement('div'); b.className='bubble '+(who==='me'?'me':'peer');
  b.innerHTML = html + (time?`<div class="meta">${time}</div>`:'');
  r.appendChild(b); messagesEl.appendChild(r); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function addMessage(text, who='peer'){
  addMessageHTML(escapeHtml(text), who, new Date().toLocaleTimeString());
}

/* ---------- CRYPTO: derive both NaCl seed and AES key from PIN ---------- */
async function deriveKeys(pin){
  const enc = new TextEncoder();
  const salt = enc.encode('onlyus-double-salt-v1');
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(pin), {name:'PBKDF2'}, false, ['deriveBits']);
  const bits = await crypto.subtle.deriveBits({name:'PBKDF2', hash:'SHA-256', salt, iterations:140000}, baseKey, 512);
  const bytes = new Uint8Array(bits);
  const seed = bytes.slice(0,32);
  const aesRaw = bytes.slice(32,64);
  const aesKeyImported = await crypto.subtle.importKey('raw', aesRaw, {name:'AES-GCM'}, false, ['encrypt','decrypt']);
  return { seed, aesKey: aesKeyImported, aesRaw };
}

/* ---------- AES-GCM ---------- */
async function aesEncrypt(aesKeyImported, plainStr){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder();
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, aesKeyImported, enc.encode(plainStr));
  const combined = new Uint8Array(iv.byteLength + ct.byteLength);
  combined.set(iv,0);
  combined.set(new Uint8Array(ct), iv.byteLength);
  return btoa(String.fromCharCode(...combined));
}
async function aesDecrypt(aesKeyImported, b64){
  const raw = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
  const iv = raw.slice(0,12);
  const ct = raw.slice(12);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, aesKeyImported, ct);
  const dec = new TextDecoder();
  return dec.decode(pt);
}

/* ---------- NaCl box (packaging) ---------- */
function naclBoxEncrypt(theirPubKeyUint8, aesCipherB64){
  const nonce = nacl.randomBytes(nacl.box.nonceLength);
  const msgBytes = nacl.util.decodeUTF8(aesCipherB64);
  const myBox = nacl.box.keyPair.fromSecretKey(myKey.secretKey.slice(0,32));
  const cipher = nacl.box(msgBytes, nonce, theirPubKeyUint8, myBox.secretKey);
  const out = new Uint8Array(nonce.length + cipher.length);
  out.set(nonce);
  out.set(cipher, nonce.length);
  return nacl.util.encodeBase64(out);
}
function naclBoxDecrypt(theirPubKeyUint8, b64){
  const data = nacl.util.decodeBase64(b64);
  const nonce = data.slice(0, nacl.box.nonceLength);
  const cipher = data.slice(nacl.box.nonceLength);
  const myBox = nacl.box.keyPair.fromSecretKey(myKey.secretKey.slice(0,32));
  const plain = nacl.box.open(cipher, nonce, theirPubKeyUint8, myBox.secretKey);
  if(!plain) throw new Error('NaCl box open failed');
  return nacl.util.encodeUTF8(plain);
}

/* ---------- Signalling & auto-join ---------- */
codeEnter.addEventListener('click', async ()=>{
  if(ws) return;
  const pin = codeField.value.trim(); if(!pin) return;
  lastPin = pin;
  const { seed, aesKey: importedAES, aesRaw } = await deriveKeys(pin);
  myKey = nacl.sign.keyPair.fromSeed(seed);
  aesKey = importedAES;
  aesRawBytes = aesRaw;
  ws = new WebSocket(SIGNAL_URL);
  ws.onopen = ()=>{ ws.send(JSON.stringify({type:'join'})); ws.send(JSON.stringify({type:'pub', pub:Array.from(myKey.publicKey)})); };
  ws.onmessage = async (ev) => {
    let d; try{ d = JSON.parse(ev.data);}catch{} if(!d) return;
    if(d.type === 'pub'){ theirKey = new Uint8Array(d.pub); }
    if(d.type === 'peer-joined'){ peerJoined = true; if(fakeMode){ fakeMode=false; messagesEl.innerHTML=''; } startRTC(true); }
    if(d.type === 'offer'){ await startRTC(false); await pc.setRemoteDescription(d.sdp); const ans = await pc.createAnswer(); await pc.setLocalDescription(ans); ws.send(JSON.stringify({type:'answer', sdp:pc.localDescription})); }
    if(d.type === 'answer'){ await pc.setRemoteDescription(d.sdp); }
    if(d.type === 'ice'){ try{ await pc.addIceCandidate(d.c); }catch(e){} }
  };
  codeModal.style.display = 'none';
  // start decoy if no peer after 40s (longer window for mobile-to-mobile)
  setTimeout(()=>{ if(!peerJoined) startFakeDecoy(); }, 40000);
});
codeCancel.addEventListener('click', ()=>{ codeModal.style.display='none'; });

/* ---------- WebRTC with TURN added ---------- */
async function startRTC(initiator){
  if(pc) return;
  pc = new RTCPeerConnection({
    iceServers:[
      { urls: "stun:stun.l.google.com:19302" },
      // TURN server (example public/free-ish) â€” replace with paid TURN for production reliability
      { urls: "turn:relay1.expressturn.com:3478", username: "efree", credential: "efree" }
    ]
  });
  pc.onicecandidate = e => { if(e.candidate && ws) ws.send(JSON.stringify({type:'ice', c:e.candidate})); };
  if(initiator){
    dc = pc.createDataChannel('onlyus'); setupDC();
    const offer = await pc.createOffer(); await pc.setLocalDescription(offer); ws.send(JSON.stringify({type:'offer', sdp:pc.localDescription}));
  } else {
    pc.ondatachannel = e => { dc = e.channel; setupDC(); };
  }
}

function setupDC(){
  dc.onopen = ()=>{};
  dc.onmessage = async (ev) => {
    try{
      const aesCipherB64 = naclBoxDecrypt(theirKey, ev.data);
      const plainJSON = await aesDecrypt(aesKey, aesCipherB64);
      const pkt = JSON.parse(plainJSON);
      if(pkt.t === 'msg') addMessage(pkt.text,'peer');
      if(pkt.t === 'file') addMessageHTML(`<img src="${pkt.data}" style="width:160px;border-radius:8px"><div style="font-size:12px;color:var(--muted)">${escapeHtml(pkt.name)}</div>`,'peer');
    }catch(err){ console.error('msg decrypt failed', err); }
  };
}

/* ---------- Send (local display + try send if connected) ---------- */
document.getElementById('sendBtn').addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
async function sendMessage(){
  const txt = messageInput.value.trim();
  if(!txt && fileInput.files.length === 0) return;

  // Always show locally immediately
  if(txt){ addMessage(txt,'me'); }

  // Try to send over DC if ready and we have peer key
  if(txt && dc && dc.readyState === 'open' && theirKey){
    try{
      const pkt = {t:'msg', text:txt, ts:Date.now()};
      const jsonStr = JSON.stringify(pkt);
      const aesB64 = await aesEncrypt(aesKey, jsonStr);
      const boxed = naclBoxEncrypt(theirKey, aesB64);
      dc.send(boxed);
    }catch(e){ console.error('send failed', e); }
  }

  // file send (if selected)
  if(fileInput.files.length && dc && dc.readyState === 'open' && theirKey){
    sendFile(fileInput.files[0]);
    filePreview.innerHTML=''; fileInput.value='';
  }

  messageInput.value='';
}

/* ---------- Files ---------- */
attachBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', ()=>{ const f = fileInput.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ filePreview.innerHTML = `<div class="fileThumb"><img class="thumbImg" src="${r.result}"><div style="font-size:13px">${f.name}</div></div>`; }; r.readAsDataURL(f); });
async function sendFile(f){
  const r = new FileReader();
  r.onload = async ()=> {
    const pkt = {t:'file', name:f.name, data:r.result, ts:Date.now()};
    const jsonStr = JSON.stringify(pkt);
    const aesB64 = await aesEncrypt(aesKey, jsonStr);
    const boxed = naclBoxEncrypt(theirKey, aesB64);
    dc.send(boxed);
    addMessage('ðŸ“ '+escapeHtml(f.name),'me');
  };
  r.readAsDataURL(f);
}

/* ---------- Fake Decoy Chat ---------- */
function startFakeDecoy(){
  fakeMode = true;
  messagesEl.innerHTML = '';
  addMessage('Hey! Are you coming today?','peer');
  setTimeout(()=> addMessage('Yes â€” will be there by 7.','me'), 1000);
  setTimeout(()=> addMessage('Bring the documents please.','peer'), 2200);
  setTimeout(()=> addMessage('Sure. See you!','me'), 3200);
  setTimeout(()=> addMessage('Shopping list:\nâ€¢ Milk\nâ€¢ Bread\nâ€¢ Eggs','peer'), 4200);
}

/* ---------- LOCAL WIPE + UNLOCK + SCREENSHOT BLOCK ---------- */
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) localWipeAndBlock(); });
let idleTimer = null;
function resetIdle(){ clearTimeout(idleTimer); idleTimer = setTimeout(()=>{ if(document.hidden) localWipeAndBlock(); }, 3500); }
window.onload = resetIdle; document.onmousemove = resetIdle; document.onkeypress = resetIdle; document.ontouchstart = resetIdle;

function localWipeAndBlock(){
  messagesEl.innerHTML = '';
  filePreview.innerHTML = '';
  blockOverlay.style.display = 'flex';
  setTimeout(()=>{ blockOverlay.style.display = 'none'; unlockOverlay.style.display = 'flex'; }, 300);
}
unlockBtn.addEventListener('click', ()=>{ const v = unlockField.value.trim(); if(v && lastPin && v === lastPin){ unlockOverlay.style.display = 'none'; unlockField.value = ''; } else { unlockField.style.border = '1px solid red'; } });

/* ---------- PrintScreen detection ---------- */
window.addEventListener('keyup', (e)=>{ if(e.key === 'PrintScreen'){ blockOverlay.style.display = 'flex'; setTimeout(()=>blockOverlay.style.display = 'none', 600); } });

/* ---------- Hidden gesture: triple swipe-up (top-left zone) ---------- */
(function setupHiddenGesture(){
  let swipeCount = 0;
  let lastTime = 0;
  let startY = null;
  let gestureTimeout = null;

  function vib(duration=30){
    if(navigator.vibrate) try{ navigator.vibrate(duration); }catch(e){}
  }

  gestureZone.addEventListener('pointerdown', (e)=>{ startY = e.clientY; });
  gestureZone.addEventListener('pointerup', (e)=>{
    if(startY === null) return;
    const dy = e.clientY - startY;
    const now = Date.now();
    if(dy < -30){
      if(swipeCount === 0) lastTime = now;
      swipeCount++;
      vib(40);
      if(gestureTimeout) clearTimeout(gestureTimeout);
      gestureTimeout = setTimeout(()=>{ swipeCount = 0; startY = null; }, 1200);
      if(swipeCount >= 3 && (now - lastTime) <= 1200){
        swipeCount = 0; startY = null;
        if(typeof window.navigator.vibrate === 'function') vib(80);
        if(unlockOverlay.style.display === 'flex'){ unlockField.focus(); }
        else {
          if(document.hidden || messagesEl.innerHTML.trim() === ''){ unlockOverlay.style.display = 'flex'; unlockField.focus(); }
          else { codeModal.style.display = 'flex'; codeField.focus(); }
        }
      }
    }
    startY = null;
  });

  let tapCount = 0;
  gestureZone.addEventListener('click', (e)=>{
    tapCount++;
    setTimeout(()=>{ tapCount = 0; }, 700);
    if(tapCount >= 4){
      tapCount = 0;
      vib(60);
      codeModal.style.display = 'flex';
      codeField.focus();
    }
  });
})();

/* ---------- Helper: escape HTML ---------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) ); }

</script>
</body>
</html>
